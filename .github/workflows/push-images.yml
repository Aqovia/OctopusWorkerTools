name: push-docker-images

on:
  push:
    branches: "*"

env:
  SUBSCRIPTON_CREDENTIALS: ${{ secrets.AZURE_AQOVIA_CI_RG_CREDENTIALS }}
  CONTAINER_REGISTRY_NAME: aqovia
  CONTAINER_REPOSITORY: octopus-workers
  IMAGE_TAG: '1.1'

jobs:
  build-and-push:
    strategy:
      matrix:
        name: ["ubuntu-20.04-node10", "ubuntu-22.04-node18", "windows-ltsc2019-node10", "windows-ltsc2019-node18"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: azure/login@v1
        name: azure cli login
        with:
          creds: ${{ env.SUBSCRIPTON_CREDENTIALS }}
      - uses: azure/CLI@v1
        name: build and push image
        with:
          inlineScript: |
            name='${{ matrix.name }}'
            platform='linux'
            if [[ "$name" == *"windows"* ]]; then
              platform='windows'
            fi
            az acr login --name ${{ env.CONTAINER_REGISTRY_NAME }} --expose-token
            az acr build \
              --registry ${{ env.CONTAINER_REGISTRY_NAME }} \
              . \
              --file '${{ matrix.name }}/dockerfile' \
              --image '${{ env.CONTAINER_REPOSITORY }}:${{ env.IMAGE_TAG }}-${{ matrix.name }}' \
              --platform $platform
